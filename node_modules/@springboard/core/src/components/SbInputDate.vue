<template>
  <div class="datefield-container">
    <div
      v-if="label"
      class="sb-form-label datefield-label"
    >
      {{ label }}<span v-if="required">*</span>
    </div>
    <div class="datefield-content">
      <sb-input
        v-model="day"
        type="number"
        :hint="hintDay"
        :has-error="errors && errors.day"
        error-message=""
        class="datefield-day"
        @change="onChange()"
      />
      <div class="datefield-separator" />
      <sb-input
        v-model="month"
        type="number"
        :hint="hintMonth"
        :has-error="errors && errors.month"
        error-message=""
        class="datefield-month"
        @change="onChange()"
      />
      <div class="datefield-separator" />
      <sb-input
        v-model="year"
        type="number"
        :hint="hintYear"
        :has-error="errors && errors.year"
        error-message=""
        class="datefield-year"
        @change="onChange()"
      />
    </div>
    <p
      v-if="hasError && errorMessage"
      class="datefield-error-message"
    >
      {{ errorMessage }}
    </p>
  </div>
</template>

<script>
import moment from 'moment'
import SbInput from './SbInput.vue'

export default {
  name: 'SbInputDate',
  components: {
    SbInput
  },
  model: {
    prop: 'value',
    event: 'change'
  },
  props: {
    /**
     * Name attribute
     */
    name: {
      type: String,
      default: ''
    },
    /**
     * Input label
     */
    label: {
      type: String,
      default: ''
    },
    /**
     * Input value
     * @model
     */
    value: {
      type: String,
      default: ''
    },
    /**
     * Defines the value as required (display error message else)
     */
    required: {
      type: Boolean,
      default: false
    },
    /**
     * Day field placeholder
     */
    hintDay: {
      type: String,
      default: 'Day'
    },
    /**
     * Month field placeholder
     */
    hintMonth: {
      type: String,
      default: 'Month'
    },
    /**
     * Year field placeholder
     */
    hintYear: {
      type: String,
      default: 'Year'
    },
    /**
     * Error message
     */
    errorMessage: {
      type: String,
      default: 'Invalid date'
    }
  },
  data () {
    const momentDate = moment(this.value)
    let objectDate = {}
    if (momentDate.isValid()) {
      objectDate.day = momentDate.get('date')
      objectDate.month = momentDate.get('month') + 1
      objectDate.year = momentDate.get('year')
    }

    return {
      day: undefined,
      month: undefined,
      year: undefined,
      ...objectDate,
      errors: {
        day: false,
        month: false,
        year: false
      }
    }
  },
  computed: {
    hasError () {
      return this.errors && (this.errors.day || this.errors.month || this.errors.year)
    }
  },
  methods: {
    checkErrors (date, required = false) {
      // in case of optional date (every fields are empty)
      if (!required && !date.day && !date.month && !date.year) {
        return false
      }

      // else, every fields should be filled
      return {
        day: !date.day,
        month: !date.month,
        year: !date.year
      }
    },

    /**
     * Returns an ISO string representation of the date,
     * or false if the date is invalid in any ways
     *
     * @returns string|false
     */
    validAndFormatDate (date) {
      let {
        day,
        month,
        year
      } = date

      if (!day || !month || !year) {
        return false
      }

      // adds prepend zero
      day = ('0' + day).slice(-2)
      month = ('0' + month).slice(-2)
      year = '' + year

      // check date validity
      const isoDate = `${year}-${month}-${day}`
      if (!moment(isoDate).isValid()) {
        // invalid date, we put all errors flags to true
        // because we don't know the exact reason
        return false
      }

      return isoDate
    },

    onChange () {
      const date = {
        day: this.day,
        month: this.month,
        year: this.year
      }

      this.errors = this.checkErrors(date, this.required)
      if (this.hasError) {
        return
      }

      /**
       * Date in ISO format `YYYY-MM-DD`
       *
       * @event change
       * @type {text}
       */
      const isoDate = this.validAndFormatDate(date)
      if (!isoDate) {
        // invalid iso date
        this.errors = {
          day: true,
          month: true,
          year: true
        }

        return
      }

      this.$emit('change', isoDate)
    }
  }
}
</script>

<style lang="less" scoped>
  @import "../less/variables";

  .datefield-container {
    padding: 10px;
    width: 100%;
    box-sizing: border-box;
    font-family: RobotoCondensed;

    .datefield-label {
      margin-bottom: 10px;
    }

    .datefield-content {
      display: flex;

      .datefield-separator {
        border-right: 1px solid @sb-grey;
        transform: rotate(10deg);
        margin: 10px 20px;
      }

      .textfield-container {
        padding: 0;
        text-align: center;
      }

      .datefield-day,
      .datefield-month {
        flex: 1;
      }

      .datefield-year {
        flex: 1.5;
      }
    }

    .datefield-error-message {
      color: @sb-red;
      font-size: 14px;
      line-height: 16px;
      padding-top: 10px;
      margin: 0;
    }
  }
</style>
