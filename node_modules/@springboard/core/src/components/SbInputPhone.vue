<template>
  <div class="phonefield-container">
    <div class="phonefield-content">
      <div class="phonefield-country">
        <div class="sb-form-label phonefield-country-label">
          {{ countryLabel }}<span v-if="required">*</span>
        </div>
        <div
          class="phonefield-country-container"
          :class="{
            'error': countryHasError
          }"
        >
          <div class="phonefield-country-flag">
            <div
              v-if="mutableCountry"
              class="flag"
              :class="`flag-${mutableCountry.cca2.toLowerCase()}`"
            />
          </div>
          <div class="phonefield-country-value sb-text-14">
            {{ mutableCountry && `+${mutableCountry.callingCode[0]}` }}
          </div>
          <div class="phonefield-country-button-container">
            <button
              class="phonefield-country-button"
              @click="openCountryModal()"
            >
              <div class="icon icon-arrow2-down" />
            </button>
          </div>
        </div>
        <p
          v-if="countryHasError"
          class="phonefield-error-message"
        >
          {{ errorMessage }}
        </p>
      </div>

      <sb-input
        v-model="mutablePhone"
        v-bind="inputAttributes"
        left-icon="mobile"
        :label="phoneLabel"
        :has-error="phoneHasError"
        :error-message="errorMessage"
        :required="required"
        class="phonefield-input-phone"
        v-on="inputListeners"
      />
    </div>

    <!-- Country selector modal -->
    <sb-modal
      v-model="showCountryModal"
      fullscreen
    >
      <template slot="header">
        <div class="phonefield-modal-header">
          <div
            class="phonefield-modal-header-close-icon"
            @click="closeCountryModal()"
          >
            <div class="icon icon-cross" />
          </div>
          <div class="phonefield-modal-header-title sb-text-18">{{ countryModalTitle }}</div>
          <div class="phonefield-search-input">
            <sb-input
              v-model="countryListFilter"
              left-icon="search"
              floating
            />
          </div>
        </div>
      </template>

      <div class="phonefield-modal-content">
        <div
          v-for="(country, index) in countryList"
          :key="index"
          class="phonefield-modal-item sb-text-14"
          @click="selectCountryAndCloseModal(country)"
        >
          <div class="country-flag">
            <div
              class="flag"
              :class="`flag-${country.cca2.toLowerCase()}`"
            />
          </div>
          <div class="country-indicator">
            +{{ country.callingCode[0] }}
          </div>
          <div class="country-name">
            {{ country.name.common }}
          </div>
        </div>
      </div>
    </sb-modal>
  </div>
</template>

<script>
import WORLD_COUNTRIES from 'world-countries'

import SbInput from './SbInput.vue'
import SbModal from './SbModal.vue'

export default {
  name: 'SbInputPhone',
  components: {
    SbInput,
    SbModal
  },
  model: {
    prop: 'value',
    event: 'input'
  },
  props: {
    /**
     * Country selector label
     */
    countryLabel: {
      type: String,
      default: ''
    },
    /**
     * Phone input label
     */
    phoneLabel: {
      type: String,
      default: ''
    },
    /**
     * Global model
     * @model
     */
    value: {
      type: Object,
      default: undefined
    },
    /**
     * Defines the value as required (display error message else)
     */
    required: {
      type: Boolean,
      default: false
    },
    /**
     * Country selector modal title
     */
    countryModalTitle: {
      type: String,
      default: 'Country code'
    },
    /**
     * Error message to display below the component
     */
    errorMessage: {
      type: String,
      default: 'This field is required'
    }
  },
  data () {
    return {
      mutableCountry: this.value ? this.getCountryFromList(this.value.country) : undefined,
      mutableCountryCode: this.value ? this.value.country : '',
      mutablePhone: this.value ? this.value.value : '',
      countryHasError: this.required && !this.value,
      phoneHasError: this.required && !this.value,
      showCountryModal: false,
      countryListFilter: ''
    }
  },
  computed: {
    countryList () {
      return this.buildCountryList(this.countryListFilter)
    },

    /**
     * Bubbles standards HTML Events to parent
     */
    inputListeners: function () {
      const vm = this

      return {
        // We add all the listeners from the parent
        ...this.$listeners,

        // override default behavior to ensures it works with v-model
        input: function () {
          vm.onEvent('input', vm.mutableValue)
        },
        change: function () {
          vm.onEvent('change', vm.mutableValue)
        }
      }
    },
    /**
     * Fallthrough parent attributes
     */
    inputAttributes: function () {
      return {
        // We add all the attributes from the parent
        ...this.$attrs
      }
    }
  },
  methods: {
    validate () {
      this.countryHasError = false
      this.phoneHasError = false

      if (!this.required) {
        return
      }

      if (!this.mutableCountryCode) {
        this.countryHasError = true
      }

      if (!this.mutablePhone) {
        this.phoneHasError = true
      }
    },
    openCountryModal () {
      this.showCountryModal = true
    },
    closeCountryModal () {
      // reset country list filter on close
      this.countryListFilter = ''

      this.showCountryModal = false
    },
    selectCountryAndCloseModal (value) {
      this.mutableCountry = value
      this.mutableCountryCode = value.cca2

      this.closeCountryModal()
      this.onEvent('input')
    },
    /**
     * @returns List of countries with calling code
     */
    buildCountryList (filter) {
      const countriesWithCallingCode = WORLD_COUNTRIES.filter(country => country.callingCode.length)

      if (!filter) {
        return countriesWithCallingCode
      }

      // return only country with name starting by filter value
      return countriesWithCallingCode.filter(country =>
        country.name.common.toLowerCase().indexOf(filter.toLowerCase()) !== -1
      )
    },
    getCountryFromList (countryCode) {
      // length should be 1 or 0
      const filterCountries = WORLD_COUNTRIES.filter(country => country.cca2 === countryCode)

      return filterCountries.length ? filterCountries[0] : undefined
    },
    onEvent (eventName) {
      this.validate()

      /**
       * Bubble `change` and `input` events
       *
       * @event change|input
       * @type {object}
       */
      this.$emit(eventName, {
        country: this.mutableCountryCode,
        value: this.mutablePhone
      })
    }
  }
}
</script>

<style lang="less" scoped>
  @import "../less/variables";

  .phonefield-container {
    width: 100%;
    font-family: RobotoCondensed;

    .phonefield-label {
      margin-bottom: 10px;
    }

    .phonefield-content {
      display: flex;

      .phonefield-input-phone {
        flex: 3;
      }

      .phonefield-country {
        flex: 1;
        padding: 10px;

        .phonefield-country-label {
          margin-bottom: 10px;
        }

        .phonefield-country-container {
          display: flex;
          width: 100%;
          min-height: 36px;
          border-radius: 2px;
          border: 1px solid @sb-grey;

          &.error {
            background-color: @sb-red-20;
          }

          .phonefield-country-flag {
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: center;

            .flag {
              // 32px x 0.6 = 19px
              transform: scale(0.6);
            }
          }

          .phonefield-country-value {
            flex: 1;
            padding: 10px 10px 10px 0;
          }

          .phonefield-country-button-container {
            position: relative;
            display: flex;
            align-items: center;

            &::after {
              width: 10px;
              height: 100%;
              display: block;
              position: absolute;
              top: 0;
              left: -3px;
              content: '';
              background: #fff;
              transform: skewX(10deg);
              border-left: 1px solid @sb-grey;
            }

            .phonefield-country-button {
              display: flex;
              justify-content: center;
              align-items: center;
              width: 36px;
              height: 100%;
              background: #fff;
              border: none;
              color: @sb-blue;
              border-radius: 0 2px 2px 0;

              &:hover {
                cursor: pointer;
              }
            }
          }
        }
      }
    }

    .phonefield-error-message {
      color: @sb-red;
      font-size: 14px;
      line-height: 16px;
      padding-top: 10px;
      margin: 0;
    }

    .phonefield-modal-header {
      position: relative;
      height: 80px;
      background: @sb-blue;
      color: @sb-white;

      .phonefield-modal-header-close-icon {
        position: absolute;
        left: 20px;
        top: 20px;
        font-size: 14px;

        &:hover {
          cursor: pointer;
        }
      }

      .phonefield-modal-header-title {
        padding-top: 20px;
        text-align: center;
        color: @sb-white;
      }

      .phonefield-search-input {
        position: absolute;
        display: block;
        bottom: 0;
        left: 20px;
        right: 20px;
        transform: translateY(50%);
      }
    }

    .phonefield-modal-content {
      padding: 25px 0 10px 0;

      .phonefield-modal-item {
        display: flex;
        align-items: center;
        padding: 8px 40px;

        &:hover {
          background: @sb-grey-mid;
          cursor: pointer;
        }

        .country-indicator {
          flex: 0 0 85px;
          font-weight: bold;
        }

        .country-flag {
          display: flex;
          justify-content: center;
          align-items: center;
          margin-right: 18px;

          .flag {
            transform: scale(0.7);
          }
        }
      }
    }
  }
</style>
